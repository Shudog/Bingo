
<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="main.css">

    <title>Heroes Bingo!</title>
</head>
<body style="background-color: #2c2f33">
    <div class="container">
        <div class="row" style="padding-top: 10px">
            <div class="col">
                <h2 style="color: #fff">Welcome to gillyShark Heroes Bingo! Please select your bingo board options below!</h2>
            </div>
        </div>
        <div id="selectorAccordion">
            <div class="row" style="padding-top: 10px">
                <div class="col" id="playerHeading" style="padding-bottom: 10px" >
                    <button class="btn btn-secondary" onclick="toggleSelectionMode('numberOfPlayers')" data-bs-toggle="collapse" data-bs-target="#numberOfPlayers" data-bs-parent="#selectorAccordion">
                        Number of Players
                    </button>

                    <button class="btn btn-secondary" onclick="toggleSelectionMode('gameMode')" data-bs-toggle="collapse" data-bs-target="#gameMode" data-bs-parent="#selectorAccordion">
                        Game Mode
                    </button>

                    <button class="btn btn-secondary" onclick="toggleSelectionMode('cclMode')" data-bs-toggle="collapse" data-bs-target="#cclMode" data-bs-parent="#selectorAccordion">
                        CCL Mode
                    </button>
                </div>

                <div class="collapse" id="numberOfPlayers">
                    <div class="form-check form-check-inline" style="padding-left: 0px;">
                        <input class="btn-check" type="checkbox" value="" id="btnSingleplayer">
                        <label class="btn btn-outline-light" for="btnSingleplayer">
                            Singleplayer: 1-4 players in your party
                        </label>
                    </div>

                    <div class="form-check form-check-inline" style="padding-left: 0px;">
                        <input class="btn-check" type="checkbox" value="" id="btnMultiplayer">
                        <label class="btn btn-outline-light" for="btnMultiplayer">
                            Multiplayer: 5 players in your party
                        </label>
                    </div>
                </div>
                <div class="collapse" id="gameMode">
                    <div class="form-check form-check-inline" style="padding-left: 0px;">
                        <input class="btn-check" type="checkbox" value="" id="btnAramSpecific">
                        <label class="btn btn-outline-light" for="btnAramSpecific">
                            ARAM-Specific
                        </label>
                    </div>
                    <div class="form-check form-check-inline" style="padding-left: 0px;">
                        <input class="btn-check" type="checkbox" value="" id="btnQuickMatchSpecific">
                        <label class="btn btn-outline-light" for="btnQuickMatchSpecific">
                            Quick Match-Specific
                        </label>
                    </div>
                    <div class="form-check form-check-inline" style="padding-left: 0px;">
                        <input class="btn-check" type="checkbox" value="" id="btnRankedMapsSpecific">
                        <label class="btn btn-outline-light" for="btnRankedMapsSpecific">
                            Storm League-Specific
                        </label>
                    </div>
                    <div class="form-check form-check-inline" style="padding-left: 0px;">
                        <input class="btn-check" type="checkbox" value="" id="btnCustom">
                        <label class="btn btn-outline-light" for="btnCustom">
                            Custom Lobbies
                        </label>
                    </div>
                </div>
                <div class="collapse" id="cclMode">
                    <div class="form-check form-check-inline" style="padding-left: 0px;">
                        <input class="btn-check" type="checkbox" value="" id="btnCCL" onclick="toggleCCLOptions()">
                        <label class="btn btn-outline-danger" for="btnCCL" onclick="toggleCCLOptions()">
                            CCL Viewer
                        </label>
                    </div>
                </div>
            </div>
        </div>
        <div class="row" style="padding-top: 10px; padding-left: 0px">
            <div class="col">
                <div class="form-check form-check-inline" style="padding-left: 0px;">
                    <button id="heroesBingoBtn" class="btn btn-success" onclick="heroesBingoEntry()">Generate New Bingo Board</button>
                </div>
                <div class="form-check form-check-inline" style="padding-left: 0px;">
                    <button id="heroesBingoBtn" class="btn btn-danger" onclick="saveCurrentBoard()">Create Bingo Board Code (Save)</button>
                </div>
                <div class="form-check form-check-inline" style="padding-left: 0px;">
                    <button id="heroesBingoBtn" class="btn btn-light" onclick="toggleLoadBingoBoardOption()">Enter Bingo Board Code (Load)</button>
                </div>
                <div id="loadBingoBoardOption" style="padding-top:10px;" hidden>
                    <div class="form-check form-check-inline" style="padding-left: 0px;">
                        <input class="form-control" type="text" value="" placeholder="Enter your code here" id="bingoBoardCodeField">
                    </div>
                    <div class="form-check form-check-inline" style="padding-left: 0px;">
                        <button id="heroesBingoBtn" class="btn btn-success" onclick="loadBingoBoard()">Enter Bingo Board Code (Load)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
</body>
</html>

<script>
    var isFirstBoard = true;
    var bingoCardsJson;
    var buttonSelection = "";
    var selectedOptions = new Array();
    var bingoBoardOptions;
    var loadedBingoBoard = false;
    window.onload = function () {
        //prepareData();
    }

    function toggleSelectionMode(element) {
        $(".collapse").each(function () {
            if ($(this).hasClass("show")) {
                if (!$(this).is(element)) {
                    $(this).removeClass("show");
                }
            }
        });
    }

    function toggleCCLOptions() {
        if (document.getElementById("btnCCL").checked) {
            document.getElementById("btnSingleplayer").checked = false;
            document.getElementById("btnSingleplayer").disabled = true;

            document.getElementById("btnMultiplayer").checked = false;
            document.getElementById("btnMultiplayer").disabled = true;

            document.getElementById("btnAramSpecific").checked = false;
            document.getElementById("btnAramSpecific").disabled = true;

            document.getElementById("btnQuickMatchSpecific").checked = false;
            document.getElementById("btnQuickMatchSpecific").disabled = true;

            document.getElementById("btnRankedMapsSpecific").checked = false;
            document.getElementById("btnRankedMapsSpecific").disabled = true;

            document.getElementById("btnCustom").checked = false;
            document.getElementById("btnCustom").disabled = true;
        } else {

            document.getElementById("btnSingleplayer").disabled = false;
            document.getElementById("btnMultiplayer").disabled = false;
            document.getElementById("btnAramSpecific").disabled = false;
            document.getElementById("btnQuickMatchSpecific").disabled = false;
            document.getElementById("btnRankedMapsSpecific").disabled = false;
            document.getElementById("btnCustom").disabled = false;
        }
    }

    function heroesBingoEntry() {
        cleanBoard();
        buttonSelection = "heroesBingo";
        loadedBingoBoard = false;
        addSelections();
        prepareData();
    }

    function addSelections() {
        if (document.getElementById("btnSingleplayer").checked) {
            selectedOptions.push("IsSingleplayer");
        }

        if (document.getElementById("btnMultiplayer").checked) {
            selectedOptions.push("IsMultiplayer");
        }

        if (document.getElementById("btnAramSpecific").checked) {
            selectedOptions.push("IsAramMaps");
        }

        if (document.getElementById("btnQuickMatchSpecific").checked) {
            selectedOptions.push("IsQuickMaps");
        }

        if (document.getElementById("btnRankedMapsSpecific").checked) {
            selectedOptions.push("IsRankedMaps");
        }

        if (document.getElementById("btnCustom").checked) {
            selectedOptions.push("IsCustom");
        }


        if (document.getElementById("btnCCL").checked) {
            selectedOptions.push("IsCCL");
        }
    }

    function prepareData() {
        retrieveJSON();

        if (isFirstBoard) {
            $(document).on('click', '#bingoBoardTD', function () {
                var color = $(this).css('background-color');
                if (color == "rgb(33, 37, 41)") {
                    $(this).css("background-color", "red");
                    $(this).css("background-image", 'url("new_gillyShark_112.png")');
                    $(this).css("background-repeat", 'no-repeat');
                    $(this).css("background-position", "center");
                    //Sets the 0 "unchecked" in the code to 1 "checked"
                    var selectedSquare = $(this);
                    bingoBoardOptions.forEach(function (element, index, array) {
                        if (element.Nickname == selectedSquare[0].firstChild.nodeValue) {
                            element.checkedIndicator = true;
                        }
                    });
                }
                else {
                    $(this).css("background-color", "rgb(33, 37, 41)");
                    $(this).css("background-image", '');
                    //Sets the 1 "checked" in the code to 0 "unchecked"
                    var selectedSquare = $(this);
                    bingoBoardOptions.forEach(function (element, index, array) {
                        if (element.Nickname == selectedSquare[0].firstChild.nodeValue) {
                            element.checkedIndicator = false;
                        }
                    });
                }
            });
            isFirstBoard = false;
        }

        //Do any extra setup stuff.
    }

    function cleanBoard() {
        if (document.getElementById("bingoDiv") != null) {
            var message = document.getElementById("bingoDiv");
            message.remove();
        }

        //if (document.getElementById("tblDivRow") != null) {
        //    var bingoBoard = document.getElementById("bingoBoard");
        //    bingoBoard.remove();
        //}

        bingoCardsJson = "";
        buttonSelection = "";
        selectedOptions = new Array();
    }

    async function retrieveJSON() {
        if (bingoCardsJson == "") {
            var fetchFile = "";
            switch (buttonSelection) {
                case "":
                    fetchFile = "HeroesBingoData.json";
                    break;
                case "heroesBingo":
                    fetchFile = "HeroesBingoData.json";
                    break;

            }
            bingoCardsJson = await fetch(fetchFile)
                .then(response => {
                    return response.json();
                });
        }

        printTable();
    }

    function printTable() {
        //body reference
        var body = document.getElementsByTagName("body")[0];

        //set up bootstrap container divs
        var containerDiv = document.createElement("div");
        containerDiv.setAttribute('class', 'container-fluid');
        containerDiv.setAttribute('id', 'bingoDiv');

        //instructions
        var instructDivRow = document.createElement("div");
        var instructDivCol = document.createElement("div");
        var instructMsg = document.createElement("h3");
        instructDivRow.setAttribute('id', 'heroesBingoMessage');
        instructDivRow.setAttribute('class', 'row justify-content-center');
        instructDivCol.setAttribute('class', 'col align-self-center');
        instructMsg.setAttribute('style', "color: #fff");
        instructMsg.innerHTML = "Mouse over each challenge for more information.";
        instructDivCol.appendChild(instructMsg);
        instructDivRow.appendChild(instructDivCol);
        containerDiv.appendChild(instructDivRow);

        // create elements <table> and a <tbody>
        var tblDivRow = document.createElement("div");
        var tblDivCol = document.createElement("div");
        tblDivRow.setAttribute('class', 'row justify-content-center');
        tblDivRow.setAttribute('id', 'tblDivRow');
        tblDivCol.setAttribute('class', 'col align-self-center');
        var tbl = document.createElement("table");
        tbl.setAttribute('class', 'table table-dark table-bordered mx-auto');
        tbl.setAttribute('id', 'bingoBoard');
        var tblBody = document.createElement("tbody");

        //Table headers - not currently needed.
        //var row = document.createElement("tr");
        //var cellText;
        //var cell;

        //cellText = document.createTextNode("Challenge");
        //cell = document.createElement("th");
        //cell.appendChild(cellText);
        //row.appendChild(cell);
        //tblBody.appendChild(row);

        var usedBingoOptions = [];
        for (var i = 0; i < 5; i++) {
            row = document.createElement("tr");
            for (var j = 0; j < 5; j++) {

                var bingoElement;
                if (!loadedBingoBoard) {
                    bingoElement = pullNewBingoSquare(usedBingoOptions);
                } else if (loadedBingoBoard) {
                    bingoElement = pullBingoSquareFromLoad(usedBingoOptions);
                }

                //Create the cell
                cellText = document.createTextNode(bingoElement.Nickname);
                cell = document.createElement("td");
                cell.appendChild(cellText);
                cell.setAttribute('title', bingoElement.Challenge);
                cell.setAttribute('class', 'td');
                cell.setAttribute('id', 'bingoBoardTD');
                cell.setAttribute('height', '135px');
                cell.setAttribute('width', '150px');
                if (bingoElement.checkedIndicator) {
                    cell.setAttribute('style', 'background-color: red; background-image: url("new_gillyShark_112.png"); background-repeat: no-repeat; background-position: center');
                }
                row.appendChild(cell);
            }
            tblBody.appendChild(row);
        }

        bingoBoardOptions = usedBingoOptions;

        // append the <tbody> inside the <table>
        tbl.appendChild(tblBody);
        // put <table> in the <body>
        tblDivCol.appendChild(tbl);
        tblDivRow.appendChild(tblDivCol);
        containerDiv.appendChild(tblDivRow);

        //invite link. This is stupid, but I'm too lazy to fix it right now.
        var inviteDivRow = document.createElement("div");
        var inviteDivCol = document.createElement("div");
        var inviteMsg = document.createElement("a");
        inviteDivRow.setAttribute('id', 'heroesBingoInvite');
        inviteDivRow.setAttribute('class', 'row justify-content-center');
        inviteDivCol.setAttribute('class', 'col align-self-center');
        inviteMsg.setAttribute('style', "color: #fff");
        inviteMsg.setAttribute('href', 'https://discord.gg/Ccyt5AchxM');
        inviteMsg.innerHTML = "Like bingo? Join the gillyShark discord!";
        inviteDivCol.appendChild(inviteMsg);
        inviteDivRow.appendChild(inviteDivCol);
        containerDiv.appendChild(inviteDivRow);

        body.appendChild(containerDiv);
    }

    function pullNewBingoSquare(usedBingoOptions) {
        //Pull until we get a bingo card we haven't used yet. Make this its own separate function if it gets any more complex.
        var bingoElement;
        var pullAgain = true;
        var masterIndex = 0;
        while (pullAgain) {
            pullAgain = false;
            var validOption = false;
            masterIndex = getRandomInt(bingoCardsJson.length);
            bingoElement = bingoCardsJson[masterIndex];
            selectedOptions.forEach(function (element, index, array) {
                if (bingoElement[element] == "Yes") {
                    validOption = true;
                } else {
                    pullAgain = true;
                }
            });
            if (validOption) {
                usedBingoOptions.forEach(function (element, index, array) {
                    if (bingoElement.Nickname == element.Nickname) {
                        pullAgain = true;
                    }
                });
            }
        }
        bingoElement["masterIndex"] = masterIndex;
        bingoElement["checkedIndicator"] = false;
        usedBingoOptions.push(bingoElement);
        return bingoElement;
    }

    function pullBingoSquareFromLoad(usedBingoOptions) {
        var bingoReference = bingoBoardOptions[usedBingoOptions.length];
        var bingoElement = bingoCardsJson[parseInt(bingoReference[0])];
        bingoElement["masterIndex"] = parseInt(bingoReference[0]);
        if (bingoReference[1] == "0") {
            bingoElement["checkedIndicator"] = false;
        } else if (bingoReference[1] == "1") {
            bingoElement["checkedIndicator"] = true;
        }
        usedBingoOptions.push(bingoElement);
        return bingoElement;
    }

    function getRandomInt(max) {
        return Math.floor(Math.random() * max);
    }

    function saveCurrentBoard() {
        bingoString = "";
        bingoBoardOptions.forEach(function (element, index, array) {
            //This will break if there are more than 10000 options. I'm not too worried at this current time.
            if (element.masterIndex < 1000) {
                bingoString = bingoString.concat("0");
                if (element.masterIndex < 100) {
                    bingoString = bingoString.concat("0");
                    if (element.masterIndex < 10) {
                        bingoString = bingoString.concat("0");
                    }
                }
            }
            bingoString = bingoString.concat(element.masterIndex.toString());
            if (element.checkedIndicator) {
                bingoString = bingoString.concat("1");
            } else {
                bingoString = bingoString.concat("0");
            }
        });
        navigator.clipboard.writeText(bingoString);
        alert("Bingo Board copied to Clipboard. Paste this into the text box to load your board. " + bingoString);
    }

    function toggleLoadBingoBoardOption() {
        var loadOption = document.getElementById("loadBingoBoardOption");
        if (loadOption.hidden) {
            loadOption.hidden = false;
        } else {
            loadOption.hidden = true;
        }
    }

    function loadBingoBoard() {
        bingoBoardOptions = [];
        var enteredCode = document.getElementById("bingoBoardCodeField").value;
        var splitCode = enteredCode.match(new RegExp('.{1,5}', 'g'));
        if (splitCode.length != 25) {
            alert("There was an error in the Bingo Board load process. Please try again, and if the problem persists, report it in the #ideas-and-bugs channel.");
            return;
        } else {
            toggleLoadBingoBoardOption();
            splitCode.forEach(function (element, index, array) {
                var bingoBoardOption = element.match(new RegExp('.{1,4}', 'g'));
                bingoBoardOptions.push(bingoBoardOption);
            });
        }
        cleanBoard();
        buttonSelection = "heroesBingo";
        loadedBingoBoard = true;
        prepareData();
    }
</script>
